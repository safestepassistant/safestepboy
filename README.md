# safestepboy
#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import logging
import asyncio
import threading
import requests
import time
from flask import Flask
from telegram import (Update, ReplyKeyboardMarkup, KeyboardButton,
                      InlineKeyboardButton, InlineKeyboardMarkup)
from telegram.ext import (Application, CommandHandler, MessageHandler, filters,
                          CallbackContext, CallbackQueryHandler)
from datetime import datetime

# Configure logging
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO)
logger = logging.getLogger(__name__)

# ‚úÖ Sening bot tokening (ishlatishga tayyor)
TOKEN = '7793563820:AAFN_t1CXcIm_jBkX6FI3e45Aek81to9uZs'
TRUSTED_CHAT_ID = 7238635484

# üåê Har bir til uchun matnlar
messages = {
    'en': {
        'welcome':
        "Hello Uraimjonova Gulnoza, welcome to SafeStep.\n\n"
        "This bot is here to support you in difficult moments.\n\n"
        "You can type:\n"
        "- 'SOS' to send emergency alert\n"
        "- 'I feel unsafe' to get help\n"
        "- 'note: your message' to save a private note\n"
        "- 'proof' to get instructions for sending evidence\n"
        "- Send photos, videos, or voice messages as evidence\n"
        "- Or share your live üìçlocation using the button below",
        'menu': [
            'üìç Location', '‚òéÔ∏è Share Contact', 'üìû Contact', 'üÜò SOS', 'üì§ Proof',
            'üõ° About SafeStep', '‚ö†Ô∏è I feel unsafe', 'üåê Website'
        ],
        'about':
        "SafeStep is a trusted system to store and send emergency data securely.",
        'proof_info':
        "Please send your photo/video/voice as proof. It will auto-delete in 5 seconds and alert the trusted contact.",
        'unsafe_info':
        "Don't worry. Tap 'SOS' or send your location. Our trusted contact will come to help.",
        'contact_info':
        "You can reach out at:\nüìß azimovasarvinoz2007@gmail.com\nüí¨ @Azimovasarvinoz2007",
        'website':
        "üåê Visit: https://safestep-site.vercel.app"
    },
    'uz': {
        'welcome':
        "Salom Uraimjonova Gulnoza, SafeStep botiga xush kelibsiz.\n\n"
        "Ushbu bot sizni qiyin paytlarda qo'llab-quvvatlash uchun yaratilgan.\n\n"
        "Siz yozishingiz mumkin:\n"
        "- 'SOS' xavfli holatda yordam so'rash uchun\n"
        "- 'I feel unsafe' xavotirda ekanligingizni bildiradi\n"
        "- 'note: sizning xabaringiz' maxfiy eslatma sifatida saqlanadi\n"
        "- 'proof' dalillar yuborish haqida ko'rsatma\n"
        "- Rasm, video, ovoz yuboring dalil sifatida\n"
        "- Yoki pastdagi tugmadan üìç joylashuvingizni ulashing",
        'menu': [
            'üìç Joylashuv', '‚òéÔ∏è Kontaktni ulashish', 'üìû Kontakt', 'üÜò SOS',
            'üì§ Dalil', 'üõ° SafeStep haqida',
            '‚ö†Ô∏è O\'zimni xavfsiz his qilmayapman', 'üåê Vebsayt'
        ],
        'about':
        "SafeStep bu ishonchli tizim bo'lib, barcha ma'lumotlaringizni xavfsiz saqlaydi va kerakli joyga yuboradi.",
        'proof_info':
        "Dalil sifatida rasm, video, ovoz yuboring. U 5 soniyada o'chadi va ishonchli kontaktga yuboriladi.",
        'unsafe_info':
        "Xavotir olmang. 'SOS' ni yuboring yoki joylashuvingizni ulashing. Yordamga chiqiladi.",
        'contact_info':
        "Bog'lanish uchun:\nüìß azimovasarvinoz2007@gmail.com\nüí¨ @Azimovasarvinoz2007",
        'website':
        "üåê Tashrif: https://safestep-site.vercel.app"
    },
    'ru': {
        'welcome':
        "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, –£—Ä–∞–∏–º–¥–∂–æ–Ω–æ–≤–∞ –ì—É–ª—å–Ω–æ–∑–∞, –¥–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ SafeStep.\n\n"
        "–≠—Ç–æ—Ç –±–æ—Ç –ø–æ–¥–¥–µ—Ä–∂–∏—Ç –≤–∞—Å –≤ —Ç—Ä—É–¥–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã.\n\n"
        "–í—ã –º–æ–∂–µ—Ç–µ:\n"
        "- –ù–∞–ø–∏—Å–∞—Ç—å 'SOS' –¥–ª—è –≤—ã–∑–æ–≤–∞ –ø–æ–º–æ—â–∏\n"
        "- 'I feel unsafe' –µ—Å–ª–∏ —á—É–≤—Å—Ç–≤—É–µ—Ç–µ –æ–ø–∞—Å–Ω–æ—Å—Ç—å\n"
        "- 'note: —Å–æ–æ–±—â–µ–Ω–∏–µ' —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ –ª–∏—á–Ω—É—é –∑–∞–º–µ—Ç–∫—É\n"
        "- 'proof' –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤\n"
        "- –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ, –≤–∏–¥–µ–æ –∏–ª–∏ –≥–æ–ª–æ—Å –∫–∞–∫ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞\n"
        "- –ò–ª–∏ –ø–æ–¥–µ–ª–∏—Ç–µ—Å—å –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ–º üìç —Å –ø–æ–º–æ—â—å—é –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ",
        'menu': [
            'üìç –õ–æ–∫–∞—Ü–∏—è', '‚òéÔ∏è –ü–æ–¥–µ–ª–∏—Ç—å—Å—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–º', 'üìû –ö–æ–Ω—Ç–∞–∫—Ç', 'üÜò SOS',
            'üì§ –î–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞', 'üõ° –û SafeStep', '‚ö†Ô∏è –Ø —á—É–≤—Å—Ç–≤—É—é –æ–ø–∞—Å–Ω–æ—Å—Ç—å',
            'üåê –í–µ–±—Å–∞–π—Ç'
        ],
        'about':
        "SafeStep ‚Äî —ç—Ç–æ —Å–∏—Å—Ç–µ–º–∞, –∫–æ—Ç–æ—Ä–∞—è –Ω–∞–¥–µ–∂–Ω–æ —Ö—Ä–∞–Ω–∏—Ç –∏ –ø–µ—Ä–µ–¥–∞–µ—Ç —ç–∫—Å—Ç—Ä–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.",
        'proof_info':
        "–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ/–≤–∏–¥–µ–æ/–∞—É–¥–∏–æ –∫–∞–∫ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ. –û–Ω–æ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–æ —á–µ—Ä–µ–∑ 5 —Å–µ–∫ –∏ –ø–µ—Ä–µ–¥–∞–Ω–æ –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ–º—É –∫–æ–Ω—Ç–∞–∫—Ç—É.",
        'unsafe_info':
        "–ù–µ –≤–æ–ª–Ω—É–π—Ç–µ—Å—å. –ù–∞–∂–º–∏—Ç–µ 'SOS' –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –ª–æ–∫–∞—Ü–∏—é. –ü–æ–º–æ—â—å —É–∂–µ –≤ –ø—É—Ç–∏.",
        'contact_info':
        "–°–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞–º–∏:\nüìß azimovasarvinoz2007@gmail.com\nüí¨ @Azimovasarvinoz2007",
        'website':
        "üåê –ü–µ—Ä–µ–π—Ç–∏: https://safestep-site.vercel.app"
    }
}

user_languages = {}

# Flask app for keepalive
app = Flask(__name__)


@app.route('/')
def home():
    return "SafeStep Bot is running! üõ°Ô∏è"


@app.route('/health')
def health():
    return {
        "status": "healthy",
        "bot": "SafeStep",
        "timestamp": datetime.now().isoformat()
    }


@app.route('/ping')
def ping():
    return {"pong": True, "time": datetime.now().isoformat()}


def run_flask():
    app.run(host='0.0.0.0', port=8080, debug=False)


def keepalive_ping():
    """Send periodic pings to keep the bot alive"""
    while True:
        try:
            time.sleep(300)  # Wait 5 minutes
            requests.get('http://127.0.0.1:8080/ping', timeout=10)
            logger.info("Keepalive ping sent")
        except Exception as e:
            logger.warning(f"Keepalive ping failed: {e}")
            time.sleep(60)  # Wait 1 minute on error


async def start(update: Update, context: CallbackContext):
    try:
        keyboard = [[InlineKeyboardButton("English", callback_data='en')],
                    [InlineKeyboardButton("O'zbek tili", callback_data='uz')],
                    [InlineKeyboardButton("–†—É—Å—Å–∫–∏–π —è–∑—ã–∫", callback_data='ru')]]
        reply_markup = InlineKeyboardMarkup(keyboard)
        await update.message.reply_text(
            "Please choose your language / Tilni tanlang:",
            reply_markup=reply_markup)
    except Exception as e:
        logger.error(f"Error in start command: {e}")
        await update.message.reply_text(
            "Sorry, an error occurred. Please try again.")


async def language_selected(update: Update, context: CallbackContext):
    try:
        query = update.callback_query
        user_id = query.from_user.id
        lang = query.data
        user_languages[user_id] = lang
        await query.answer()
        await query.edit_message_text(messages[lang]['welcome'])
        await show_menu(query, lang)
    except Exception as e:
        logger.error(f"Error in language selection: {e}")
        await query.answer("Sorry, an error occurred.")
        await query.message.reply_text("Please try again with /start")


async def show_menu(source, lang):
    try:
        keyboard = [[
            KeyboardButton(text=messages[lang]['menu'][0],
                           request_location=True)
        ],
                    [
                        KeyboardButton(text=messages[lang]['menu'][1],
                                       request_contact=True)
                    ], [messages[lang]['menu'][2], messages[lang]['menu'][3]],
                    [messages[lang]['menu'][4], messages[lang]['menu'][5]],
                    [messages[lang]['menu'][6], messages[lang]['menu'][7]]]
        markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
        await source.message.reply_text("üìã Menu:", reply_markup=markup)
    except Exception as e:
        logger.error(f"Error showing menu: {e}")
        await source.message.reply_text(
            "Error displaying menu. Please try /start again.")


async def handle_message(update: Update, context: CallbackContext):
    user_id = update.message.from_user.id
    lang = user_languages.get(user_id, 'en')
    text = update.message.text.lower()

    if 'sos' in text:
        user = update.message.from_user
        timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

        # Store SOS info temporarily
        context.user_data['pending_sos'] = {
            'user': user,
            'timestamp': timestamp,
            'type': 'text_sos'
        }

        # Request location
        location_keyboard = [[
            KeyboardButton("üìç Share My Location", request_location=True)
        ]]
        location_markup = ReplyKeyboardMarkup(location_keyboard,
                                              resize_keyboard=True,
                                              one_time_keyboard=True)

        await update.message.reply_text(
            "üö® SOS received! Please share your location immediately so we can send help:",
            reply_markup=location_markup)

    elif 'proof' in text:
        await update.message.reply_text(messages[lang]['proof_info'])

    elif 'i feel unsafe' in text:
        await update.message.reply_text(messages[lang]['unsafe_info'])

    elif 'note:' in text:
        note = text.replace('note:', '', 1).strip()
        await context.bot.send_message(
            chat_id=TRUSTED_CHAT_ID,
            text=f"üìù Note from {update.message.from_user.full_name}:\n{note}")
        await update.message.reply_text("üìù Note saved.")

    elif update.message.text == messages[lang]['menu'][2]:  # Contact
        contact_msg = "üìû You can contact with trusted person:\n\n"
        contact_msg += "üìß Email: azimovasarvinoz2007@gmail.com\n"
        contact_msg += "üí¨ Telegram: @Azimovasarvinoz2007"
        await update.message.reply_text(contact_msg)

    elif update.message.text == messages[lang]['menu'][5]:  # About SafeStep
        about_msg = "üõ°Ô∏è About SafeStep:\n\n"
        about_msg += "SafeStep is a trustful system which helps users to save proofs securely. "
        about_msg += "Our system helps users as soon as we get a signal from them. "
        about_msg += "All your emergency data is stored safely and accessible only to trusted contacts when you need help."
        await update.message.reply_text(about_msg)

    elif update.message.text == messages[lang]['menu'][7]:  # Website
        await update.message.reply_text(
            "üåê Visit our website: https://safestep-site.vercel.app/")

    elif update.message.text == messages[lang]['menu'][4]:
        await update.message.reply_text(messages[lang]['proof_info'])

    elif update.message.text == messages[lang]['menu'][6]:
        await update.message.reply_text(messages[lang]['unsafe_info'])

    elif update.message.text == messages[lang]['menu'][3]:  # SOS button
        user = update.message.from_user
        timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

        # Store SOS info temporarily
        context.user_data['pending_sos'] = {
            'user': user,
            'timestamp': timestamp,
            'type': 'button_sos'
        }

        # Request location
        location_keyboard = [[
            KeyboardButton("üìç Share My Location", request_location=True)
        ]]
        location_markup = ReplyKeyboardMarkup(location_keyboard,
                                              resize_keyboard=True,
                                              one_time_keyboard=True)

        await update.message.reply_text(
            "üö® Emergency SOS activated! Please share your location immediately:",
            reply_markup=location_markup)


async def handle_location(update: Update, context: CallbackContext):
    loc = update.message.location
    user = update.message.from_user
    user_id = update.message.from_user.id
    lang = user_languages.get(user_id, 'en')

    # Check if this is in response to SOS or proof request
    if context.user_data.get('pending_sos'):
        sos_data = context.user_data['pending_sos']

        # Create comprehensive SOS alert with location
        alert = f"üö® EMERGENCY SOS ALERT üö®\n\n"
        alert += f"üë§ Full Name: {user.full_name}\n"
        alert += f"üì± Username: @{user.username if user.username else 'No username'}\n"
        alert += f"üÜî User ID: {user.id}\n"
        alert += f"üìÖ Date & Time: {sos_data['timestamp']}\n"
        alert += f"üîó User Link: tg://user?id={user.id}\n"
        alert += f"üìç Location: https://maps.google.com/?q={loc.latitude},{loc.longitude}\n"
        alert += f"üó∫Ô∏è Coordinates: {loc.latitude}, {loc.longitude}\n\n"
        alert += f"‚ö†Ô∏è IMMEDIATE ASSISTANCE REQUIRED!"

        await context.bot.send_message(chat_id=TRUSTED_CHAT_ID, text=alert)

        # Clear the pending SOS
        del context.user_data['pending_sos']

        # Show main menu again
        await show_menu(update, lang)
        await update.message.reply_text(
            "‚úÖ Emergency alert with location sent to trusted contact!")

    elif context.user_data.get('pending_proof'):
        proof_data = context.user_data['pending_proof']

        # Create comprehensive proof report with location
        report = f"üì§ PROOF EVIDENCE WITH LOCATION üì§\n\n"
        report += f"üë§ Full Name: {user.full_name}\n"
        report += f"üì± Username: @{user.username if user.username else 'No username'}\n"
        report += f"üÜî User ID: {user.id}\n"
        report += f"üìÖ Date & Time: {proof_data['timestamp']}\n"
        report += f"üîó User Link: tg://user?id={user.id}\n"
        report += f"üìã Media Type: {proof_data['media_type']}\n"
        report += f"üìç Location: https://maps.google.com/?q={loc.latitude},{loc.longitude}\n"
        report += f"üó∫Ô∏è Coordinates: {loc.latitude}, {loc.longitude}\n\n"
        report += f"üìé Evidence attached above this message"

        await context.bot.send_message(chat_id=TRUSTED_CHAT_ID, text=report)

        # Clear the pending proof
        del context.user_data['pending_proof']

        # Show main menu again
        await show_menu(update, lang)
        await update.message.reply_text(
            "‚úÖ Proof evidence with location sent to trusted contact!")

    else:
        # Regular location sharing
        await context.bot.send_message(
            chat_id=TRUSTED_CHAT_ID,
            text=
            f"üìç Location from {user.full_name} (@{user.username}):\nhttps://maps.google.com/?q={loc.latitude},{loc.longitude}"
        )
        await update.message.reply_text("üìç Location sent.")


async def handle_contact(update: Update, context: CallbackContext):
    contact = update.message.contact
    user = update.message.from_user
    await context.bot.send_message(
        chat_id=TRUSTED_CHAT_ID,
        text=
        f"üìû Contact from {user.full_name}:\nName: {contact.first_name}\nPhone: {contact.phone_number}"
    )
    await update.message.reply_text("üìû Contact shared.")


async def handle_media(update: Update, context: CallbackContext):
    user = update.message.from_user
    timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    file = None
    media_type = ""

    if update.message.photo:
        file = update.message.photo[-1]
        media_type = "Photo"
    elif update.message.video:
        file = update.message.video
        media_type = "Video"
    elif update.message.voice:
        file = update.message.voice
        media_type = "Voice message"

    if file:
        # Forward the media to trusted account first
        await update.message.forward(chat_id=TRUSTED_CHAT_ID)

        # Store proof info temporarily
        context.user_data['pending_proof'] = {
            'user': user,
            'timestamp': timestamp,
            'media_type': media_type
        }

        # Request location
        location_keyboard = [[
            KeyboardButton("üìç Share My Location", request_location=True)
        ]]
        location_markup = ReplyKeyboardMarkup(location_keyboard,
                                              resize_keyboard=True,
                                              one_time_keyboard=True)

        # Confirm to user and request location
        confirmation = await update.message.reply_text(
            f"‚úÖ {media_type} evidence received! Please share your location to complete the report:",
            reply_markup=location_markup)

        # Auto-delete the original media after 5 seconds
        async def delete_proof():
            await asyncio.sleep(5)
            try:
                await context.bot.delete_message(
                    chat_id=update.message.chat_id,
                    message_id=update.message.message_id)
            except Exception as e:
                logger.warning(f"Could not delete proof message: {e}")

        # Run deletion in background
        asyncio.create_task(delete_proof())


def main():
    try:
        # Start Flask server in background thread
        flask_thread = threading.Thread(target=run_flask, daemon=True)
        flask_thread.start()
        logger.info("Flask keepalive server started on port 8080")

        # Start keepalive ping thread
        ping_thread = threading.Thread(target=keepalive_ping, daemon=True)
        ping_thread.start()
        logger.info("Keepalive ping thread started")

        application = Application.builder().token(TOKEN).build()

        application.add_handler(CommandHandler("start", start))
        application.add_handler(CallbackQueryHandler(language_selected))
        application.add_handler(
            MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
        application.add_handler(
            MessageHandler(filters.LOCATION, handle_location))
        application.add_handler(MessageHandler(filters.CONTACT,
                                               handle_contact))
        application.add_handler(
            MessageHandler(filters.PHOTO | filters.VIDEO | filters.VOICE,
                           handle_media))

        logger.info("SafeStep bot started successfully")
        application.run_polling()
    except Exception as e:
        logger.error(f"Error starting bot: {e}")
        print(f"Failed to start bot: {e}")


if __name__ == '__main__':
    main()
